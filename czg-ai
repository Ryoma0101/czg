#!/usr/bin/env bash

# czg-ai: Commit with AI-generated message using czg
# Usage: czg-ai

set -euo pipefail

CONFIG_DIR="$HOME/.config/czg"
GEMINI_SCRIPT="$CONFIG_DIR/gemini-commit.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if gemini-commit.sh exists
if [ ! -f "$GEMINI_SCRIPT" ]; then
    echo -e "${RED}Error: $GEMINI_SCRIPT not found${NC}" >&2
    exit 1
fi

# Check if GEMINI_API_KEY is set
if [ -z "${GEMINI_API_KEY:-}" ]; then
    echo -e "${RED}Error: GEMINI_API_KEY is not set${NC}" >&2
    echo "Please set your Gemini API key:" >&2
    echo "  export GEMINI_API_KEY='your-api-key'" >&2
    echo "" >&2
    echo "Get your API key from: https://aistudio.google.com/app/apikey" >&2
    exit 1
fi

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ðŸ¤– AI Commit Message Generator${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Generate commit message
echo -e "${YELLOW}ðŸ“ Analyzing changes...${NC}"
GENERATED_MSG=$(bash "$GEMINI_SCRIPT")

if [ $? -ne 0 ] || [ -z "$GENERATED_MSG" ]; then
    echo -e "${RED}Failed to generate commit message${NC}" >&2
    exit 1
fi

echo ""
echo -e "${GREEN}âœ¨ Generated commit message:${NC}"
echo -e "${BLUE}$GENERATED_MSG${NC}"
echo ""

# Ask for confirmation
echo -e "${YELLOW}Options:${NC}"
echo "  1) Use this message and commit"
echo "  2) Edit with czg"
echo "  3) Cancel"
echo -n "Choose [1-3]: "
read -r choice

case $choice in
    1)
        echo ""
        echo -e "${GREEN}Committing with AI-generated message...${NC}"
        git commit -m "$GENERATED_MSG"
        echo -e "${GREEN}âœ“ Committed successfully!${NC}"
        echo ""
        echo -e "${BLUE}Press Enter to return to lazygit...${NC}"
        read -r
        ;;
    2)
        echo ""
        echo -e "${GREEN}Opening czg with suggested message...${NC}"
        # Export the message for czg to use
        export CZ_DEFAULT_SUBJECT="$GENERATED_MSG"
        czg
        echo ""
        echo -e "${BLUE}Press Enter to return to lazygit...${NC}"
        read -r
        ;;
    3)
        echo ""
        echo -e "${YELLOW}Cancelled${NC}"
        exit 0
        ;;
    *)
        echo ""
        echo -e "${RED}Invalid choice. Cancelled.${NC}"
        exit 1
        ;;
esac
