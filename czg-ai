#!/usr/bin/env bash

# czg-ai: Commit with AI-generated message using czg
# Usage: czg-ai

set -euo pipefail

CONFIG_DIR="$HOME/.config/czg"
GEMINI_SCRIPT="$CONFIG_DIR/gemini-commit.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if gemini-commit.sh exists
if [ ! -f "$GEMINI_SCRIPT" ]; then
    echo -e "${RED}Error: $GEMINI_SCRIPT not found${NC}" >&2
    exit 1
fi

# Check if GEMINI_API_KEY is set
if [ -z "${GEMINI_API_KEY:-}" ]; then
    echo -e "${RED}Error: GEMINI_API_KEY is not set${NC}" >&2
    echo "Please set your Gemini API key:" >&2
    echo "  export GEMINI_API_KEY='your-api-key'" >&2
    echo "" >&2
    echo "Get your API key from: https://aistudio.google.com/app/apikey" >&2
    exit 1
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}🤖 AIコミットメッセージ生成${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Generate commit message
echo -e "${YELLOW}📝 変更を解析中...${NC}"
GENERATED_MSG=$(bash "$GEMINI_SCRIPT")

if [ $? -ne 0 ] || [ -z "$GENERATED_MSG" ]; then
    echo -e "${RED}コミットメッセージの生成に失敗しました${NC}" >&2
    exit 1
fi

echo ""
echo -e "${GREEN}✨ 生成されたコミットメッセージ:${NC}"
echo -e "${BLUE}$GENERATED_MSG${NC}"
echo ""

# Ask for confirmation
echo -e "${YELLOW}選択してください:${NC}"
echo "  1) このメッセージでコミット"
echo "  2) czgで編集"
echo "  3) キャンセル"
echo -n "[1-3]を選択: "
read -r choice

case $choice in
    1)
        echo ""
        echo -e "${GREEN}コミット中...${NC}"
        git commit -m "$GENERATED_MSG"
        echo -e "${GREEN}✓ コミット成功${NC}"
        echo ""
        echo -n "Enterキーでlazygitに戻る..."
        read -r
        ;;
    2)
        echo ""
        echo -e "${GREEN}czgを起動中...${NC}"
        # Export the message for czg to use
        export CZ_DEFAULT_SUBJECT="$GENERATED_MSG"
        czg --config=/Users/fuka/.config/czg/.czrc
        exit_status=$?
        if [ $exit_status -ne 0 ]; then
            echo ""
            echo -n "Enterキーでlazygitに戻る..."
            read -r
        fi
        ;;
    3)
        echo ""
        echo -e "${YELLOW}キャンセルしました${NC}"
        echo ""
        echo -n "Enterキーでlazygitに戻る..."
        read -r
        exit 0
        ;;
    *)
        echo ""
        echo -e "${RED}無効な選択です。キャンセルしました${NC}"
        echo ""
        echo -n "Enterキーでlazygitに戻る..."
        read -r
        exit 1
        ;;
esac
