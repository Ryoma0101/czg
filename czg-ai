#!/usr/bin/env bash

# czg-ai: Commit with AI-generated message using czg
# Usage: czg-ai

set -euo pipefail

CONFIG_DIR="$HOME/.config/czg"
GEMINI_SCRIPT="$CONFIG_DIR/gemini-commit.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if gemini-commit.sh exists
if [ ! -f "$GEMINI_SCRIPT" ]; then
    echo -e "${RED}Error: $GEMINI_SCRIPT not found${NC}" >&2
    exit 1
fi

# Check if GEMINI_API_KEY is set
if [ -z "${GEMINI_API_KEY:-}" ]; then
    echo -e "${RED}Error: GEMINI_API_KEY not set${NC}" >&2
    exit 1
fi

# Generate commit message
GENERATED_MSG=$(bash "$GEMINI_SCRIPT")

if [ $? -ne 0 ] || [ -z "$GENERATED_MSG" ]; then
    echo -e "${RED}コミットメッセージの生成に失敗しました${NC}" >&2
    exit 1
fi

echo ""
echo -e "${GREEN}✨ 生成されたコミットメッセージ:${NC}"
echo -e "${BLUE}$GENERATED_MSG${NC}"
echo ""

# Ask for confirmation
echo -e "${YELLOW}選択してください:${NC}"
echo "  1) このメッセージでコミット"
echo "  2) 生成メッセージを編集して確定"
echo "  3) czgで編集（新規作成）"
echo "  4) キャンセル"
echo -n "[1-4]を選択: "
read -r choice

case $choice in
    1)
        git commit -m "$GENERATED_MSG"
        ;;
    2)
        # 生成メッセージを編集して確定
        echo -e "\n${YELLOW}編集モード: 生成されたメッセージを編集してください（Enterで確定）${NC}"
        echo "初期メッセージ: $GENERATED_MSG"
        echo -n "編集後のメッセージを入力（空欄なら初期メッセージを使用）: "
        read EDITED_MSG
        if [ -z "$EDITED_MSG" ]; then
            EDITED_MSG="$GENERATED_MSG"
        fi
        git commit -m "$EDITED_MSG"
        ;;
    3)
        export CZ_DEFAULT_SUBJECT=""
        czg --config="$HOME/.config/czg/.czrc"
        ;;
    4)
        exit 0
        ;;
    *)
        exit 1
        ;;
esac
